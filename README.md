Using Chef with Vagrant for provisioning virtual machines
=========================================================

Workstation Setup
-----------------

Install [Virtualbox 4.2+](https://www.virtualbox.org/wiki/Downloads) and [Vagrant 1.2+](http://downloads.vagrantup.com/) for your operating system.

Execute the Opscode Chef omnibus installer

`$ curl -L https://www.opscode.com/chef/install.sh | sudo bash`

Finally, to reduce typing in the future, add Omnibus Ruby to your path:

`$ echo 'export PATH="/opt/chef/embedded/bin:$PATH"' >> ~/.bash_profile && source ~/.bash_profile`

* Either 'git clone' or 'download zip and expand' this repository onto your workstation
* Next...

```
$ cd vagrant-chef-demo
$ vagrant up
```

Your First Cookbook
===================

Write the Recipe
----------------

In the default recipe cookbooks/ntp/recipes/default.rb, add the following:

Install the NTP package. The package provider is built into Chef - it will check to see the running operating system and use the appropriate method (yum, apt, etc):

```ruby
package 'ntp'
```

Next we need to write out the NTP configuration template using Chef's Template provider:

```ruby
template '/etc/ntp.conf' do
  source    'ntp.conf.erb'
  notifies  :restart, 'service[ntpd]'
end
```

Finally, alert Chef of the service and start it:

```ruby
service 'ntpd' do
  action [:enable, :start]
end
```

Your final recipe should look like this:

```ruby
package 'ntp'

template '/etc/ntp.conf' do
  source    'ntp.conf.erb'
  notifies  :restart, 'service[ntpd]'
end

service 'ntpd' do
  action [:enable, :start]
end
```

Create the Template
-------------------

Create a new file in templates/default/ntp.conf.erb (since that's what we provided to the source attribute in the previous step) and add the following:

```ruby
# This file was generated by Chef for '<%= node['fqdn'] %>'.
# Do NOT edit this file by hand!

restrict default kod nomodify notrap nopeer noquery
restrict -6 default kod nomodify notrap nopeer noquery
restrict 127.0.0.1
restrict -6 ::1
server '0.pool.ntp.org'
server  127.127.1.0     # local clock
driftfile /var/lib/ntp/drift
keys /etc/ntp/keys
```

Wrap Up
-------
There are some final (and optional depending on your setup) steps:

* Commit these changes to git (if you're using peforce)
* Upload this cookbook to the Chef Server (if you're using Hosted or Private Chef)
* Look on the [community site](http://community.opscode.com/):

If you look on the community site you'll see there's already an NTP cookbook. Oh no!
This brings up an important rule in the Chef world - always check the community site first before writing your own cookbook. The community cookbook is much more feature-complete than the one we've written and is designed to fit more use cases. While this cookbook serves as a great learning process, always check the community site before developing your own cookbook.

Retrospective
-------------

Compare your cookbook to the [community cookbook](http://community.opscode.com/cookbooks/ntp)