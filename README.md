Getting Started with Chef for Configuration Management
======================================================

Workstation Setup
-----------------

Install [Virtualbox 4.2+](https://www.virtualbox.org/wiki/Downloads) and [Vagrant 1.2+](http://downloads.vagrantup.com/) for your operating system.

Execute the Opscode Chef omnibus installer

`$ curl -L https://www.opscode.com/chef/install.sh | sudo bash`

Finally, to reduce typing in the future, add Omnibus Ruby to your path:

`$ echo 'export PATH="/opt/chef/embedded/bin:$PATH"' >> ~/.bash_profile && source ~/.bash_profile`

* Either 'git clone' or 'download zip and expand' this repository onto your workstation
* Next...

```
$ cd vagrant-chef-demo
$ vagrant up
```

Your First Cookbook
===================

Write the Recipe
----------------

In the default recipe cookbooks/ntp/recipes/default.rb, add the following:

Install the NTP package. The package provider is built into Chef - it will check to see the running operating system and use the appropriate method (yum, apt, etc):

```ruby
package 'ntp'
```

Next we need to write out the NTP configuration template using Chef's Template provider:

```ruby
template '/etc/ntp.conf' do
  source    'ntp.conf.erb'
  mode 0755
  notifies  :restart, 'service[ntpd]'
end
```

Finally, alert Chef of the service and start it:

```ruby
service 'ntpd' do
  action [:enable, :start]
end
```

Your final recipe should look like this:

```ruby
package 'ntp'

template '/etc/ntp.conf' do
  source    'ntp.conf.erb'
  mode 0755
  notifies  :restart, 'service[ntpd]'
end

service 'ntpd' do
  action [:enable, :start]
end
```

#### References
* [About the Package resource](http://docs.opscode.com/resource_package.html)
* [About the Template resource](http://docs.opscode.com/essentials_cookbook_templates.html)
* [About the Service resource](http://docs.opscode.com/resource_service.html)


Create the Template
-------------------

Create a new file in cookbooks/ntp/templates/default/ntp.conf.erb (since that's what we provided to the source attribute in the previous step) and add the following:

```ruby
# This file was generated by Chef for '<%= node['fqdn'] %>'.
# Do NOT edit this file by hand!

restrict default kod nomodify notrap nopeer noquery
restrict -6 default kod nomodify notrap nopeer noquery
restrict 127.0.0.1
restrict -6 ::1
server '0.pool.ntp.org'
server  127.127.1.0     # local clock
driftfile /var/lib/ntp/drift
keys /etc/ntp/keys
```

Rerun the Chef provisioner
--------------------------

```
>vagrant provision
```

Verify the Results
------------------

### First ssh into the virtual instance

```
>vagrant ssh
```

### Next confirm the file permissions from the 'mode' attribute of the 'template' resource
```
>ls -al /etc/ntp.conf
-rwxr-xr-x 1 root root 350 May 13 18:54 /etc/ntp.conf
```

### Next confirm the contents of the 'ntp.conf' file
```
>cat /etc/ntp.conf
# This file was generated by Chef for 'your-machines-fqdn'.
# Do NOT edit this file by hand!

restrict default kod nomodify notrap nopeer noquery
restrict -6 default kod nomodify notrap nopeer noquery
restrict 127.0.0.1
restrict -6 ::1
server '0.pool.ntp.org'
server  127.127.1.0     # local clock
driftfile /var/lib/ntp/drift
keys /etc/ntp/keys
```

### Finally confirm the 'ntpd' service is running
```
>service ntpd status
ntpd (pid  ####) is running...
```

Retrospective
-------------

Compare your cookbook to the [NTP Community Cookbook](http://community.opscode.com/cookbooks/ntp)

Additional Resources
--------------------
[Opscode Community Site](http://community.opscode.com/)